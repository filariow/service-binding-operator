version: "3"
services:
  app:
    user: "${UID}:${GID}"
    build:
      args:
        UID: ${UID}
        GID: ${GID}
        UNAME: ${USER}
      context: ../
      dockerfile: .devcontainers/Dockerfile
    working_dir: /sbo
    volumes:
      - ../:/sbo
    environment:
      KUBECONFIG: /home/${USER}/.kube/config
      DOCKER_HOST: tcp://dind:2375
      OPERATOR_REPO_REF: registry:5000/sbo
    links:
      - dind
    depends_on:
      dind:
        condition: service_healthy

  dind:
    hostname: kubernetes
    image: docker:dind
    privileged: true
    environment:
      DOCKER_TLS_CERTDIR: ""
    expose:
    - 2375
    volumes:
      - ./docker-daemon.json:/etc/docker/daemon.json
    healthcheck:
      test: ["CMD-SHELL", "docker", "ps"]
      interval: 5s
      timeout: 5s
      retries: 10
    links:
      - registry

  registry:
    image: registry:2
    restart: always

