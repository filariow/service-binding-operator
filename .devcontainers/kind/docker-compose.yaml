version: "3"
services:
  app:
    user: "${USER:-vscode}"
    build:
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
        USER: ${USER:-vscode}
      context: ../../
      dockerfile: .devcontainers/kind/Dockerfile
    working_dir: /sbo
    volumes:
      - ../../:/sbo:cached
    environment:
      KUBECONFIG: /home/${USER:-vscode}/.kube/config
      DOCKER_HOST: tcp://dind:2375
      OPERATOR_REPO_REF: registry:5000/sbo
      DOCKER_BUILDKIT: 1
      COMPOSE_DOCKER_CLI_BUILD: 1
    links:
      - dind
    depends_on:
      dind:
        condition: service_healthy

  dind:
    hostname: kubernetes
    image: docker:dind
    privileged: true
    environment:
      DOCKER_TLS_CERTDIR: ""
    expose:
    - 2375
    volumes:
      - ./docker-daemon.json:/etc/docker/daemon.json
    healthcheck:
      test: ["CMD-SHELL", "docker", "ps"]
      interval: 2s
      timeout: 2s
      retries: 20
    links:
      - registry

  registry:
    image: registry:2
    restart: always

